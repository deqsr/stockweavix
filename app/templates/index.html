{% extends 'layout.html' %}
{% block title %}Головна — StockWeavix{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row g-3">
    <!-- KPI -->
    <div class="col-md-4">
      <div class="card shadow-sm p-3">
        <h6 class="text-muted">Нові замовлення</h6>
        <h2>{{ new_orders }}</h2>
        <small class="text-success">{{ order_growth }} за місяць</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3">
        <h6 class="text-muted">Продажі</h6>
        <h2>{{ total_sales }} ₴</h2>
        <small class="text-success">{{ sales_growth }} за місяць</small>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm p-3">
        <h6 class="text-muted">Загальна кількість замовлень</h6>
        <h2>{{ total_orders }}</h2>
        <small class="text-success"><br></small>
      </div>
    </div>
  </div>

  <!-- Таблиці -->
  <div class="row mt-4 g-3">
    <!-- Поставки -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Прийом поставок</div>
        <div class="card-body p-0">
          <table class="table table-fixed mb-0">
            <thead class="table-light">
              <tr><th>ID</th><th>Дата</th><th>Статус</th><th>Δ%</th></tr>
            </thead>
            <tbody>
              {% for s in supplies %}
              <tr>
                <td>{{ s.id }}</td>
                <td>{{ s.date }}</td>
                <td>{{ s.status }}</td>
                <td>{{ s.change }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Зони -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Рівень завантаження зон</div>
        <div class="card-body p-0">
          <table class="table table-fixed mb-0">
            <thead class="table-light">
              <tr><th>Зона</th><th>Статус</th><th>К-сть</th><th>% завантаження</th></tr>
            </thead>
            <tbody>
              {% for z in zones %}
              <tr>
                <td>{{ z.zone }}</td>
                <td>{{ z.status }}</td>
                <td>{{ z.quantity }}</td>
                <td>{{ z.used_pct }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Графік продажів -->
  <div class="row mt-4">
    <div class="col">
      <div class="card shadow-sm p-3">
        <div class="card-header">Графік продажів (30 днів)</div>
        <div class="card-body">
          <canvas id="salesChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Топ міст -->
  <div class="row mt-4">
    <div class="col">
      <div class="card shadow-sm">
        <div class="card-header">Топ міст за рік</div>
        <div class="card-body p-0">
          <table class="table table-fixed mb-0">
            <thead class="table-light">
              <tr><th>Місто</th><th>Замовлень</th><th>Δ%</th></tr>
            </thead>
            <tbody>
              {% for c in top_cities %}
              <tr>
                <td>{{ c.city }}</td>
                <td>{{ c.cnt }}</td>
                <td>{{ c.change }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('salesChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ chart_labels|tojson }},
      datasets: [{
        label: 'Сума продажів',
        data: {{ chart_values|tojson }},
        fill: false,
        tension: 0.2,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
